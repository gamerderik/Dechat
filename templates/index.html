<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>DerikChat</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}">
    <script src="https://cdn.socket.io/4.5.1/socket.io.min.js"></script>
</head>
<body>

    <h1>DerikChat</h1>
    <!-- Logout Button placed at top right -->
    <a href="{{ url_for('logout') }}">
        <button class="logout-button">Logout</button>
    </a>

    <h2>Post a Message:</h2>
    <textarea id="messageBox" placeholder="Write your message here..." required></textarea><br>
    <button id="sendButton">Post Message</button>

    <hr>

    <h2>Messages:</h2>
<div class="message-container" id="messages">
    {% for message in messages %}
        <div class="message-box">
            <strong>{{ message[0] }}:</strong> <span>{{ message[1]|safe }}</span>
        </div>
    {% endfor %}
</div>


    <div class="admin-form">
        <h3>Admin - Clear All Messages</h3>
        <form method="POST" action="{{ url_for('home') }}">
            <input type="password" name="clear_password" placeholder="Enter admin password" required>
            <button type="submit">Clear All Messages</button>
        </form>
        {% if error_message %}
            <div class="error-message">
                {{ error_message }}
            </div>
        {% endif %}
    </div>

    <script>
    const socket = io();  // Connect to the Socket.IO server
    const username = "{{ session['username'] }}";  // Get the current username from Flask session

    // Automatically adjust the height of the textarea based on content
    document.addEventListener('input', function (event) {
        if (event.target.tagName === 'TEXTAREA') {
            event.target.style.height = 'auto';  // Reset height
            event.target.style.height = (event.target.scrollHeight) + 'px';  // Set new height based on content
        }
    });


        // Function to append messages to the chat window
        function appendMessage(username, message) {
            const messagesDiv = document.getElementById('messages');
            const newMessage = document.createElement('div');
            newMessage.className = 'message-box';
            newMessage.innerHTML = `<strong>${username}:</strong> <span>${message}</span>`;
            messagesDiv.appendChild(newMessage);
            messagesDiv.scrollTop = messagesDiv.scrollHeight;  // Auto-scroll to the bottom
        }

        // Send message to the server
        document.getElementById('sendButton').addEventListener('click', () => {
            const messageBox = document.getElementById('messageBox');
            const message = messageBox.value.trim();
            if (message) {
                socket.emit('send_message', { username, message });
                messageBox.value = '';  // Clear the input box
            }
        });

        // Listen for incoming messages
        socket.on('receive_message', (data) => {
            appendMessage(data.username, data.message);
        });

        // Listen for the message history from the server
        socket.on('message_history', (data) => {
            const messages = data.messages;  // Array of previous messages
            messages.forEach(([username, message]) => {
              appendMessage(username, message);  // Add each message to the chat window
           });
       });

    </script>

</body>
</html>
